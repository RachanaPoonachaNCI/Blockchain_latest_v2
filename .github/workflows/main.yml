name: Deploy to ECR
on:
 push:
   branches: [ main ]
env:
 ECR_REPOSITORY: devops
 EKS_CLUSTER_NAME: devops_blockchain_cluster
 AWS_REGION: eu-north-1
jobs:
 sonarcloud:
   name: SonarCloud Scan
   runs-on: ubuntu-latest
   steps:
   - name: Checkout code
     uses: actions/checkout@v3
     with:
       fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
   - name: SonarCloud Scan
     uses: SonarSource/sonarcloud-github-action@master
     env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
       SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
     with:
       args: >
         -Dsonar.qualitygate.wait=true
 deploy:
   name: Deployment to ECR and EKS
   runs-on: ubuntu-latest
   needs: sonarcloud
   steps:
   - name: Set short git commit SHA
     id: commit
     uses: prompt/actions-commit-hash@v2
   - name: Checkout code
     uses: actions/checkout@v3
     with:
       fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
   - name: Configure AWS credentials
     uses: aws-actions/configure-aws-credentials@v1
     with:
       aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
       aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
       aws-region: ${{env.AWS_REGION}}
   - name: Login to Amazon ECR
     id: login-ecr
     uses: aws-actions/amazon-ecr-login@v1
   - name: Build, tag, and push image to Amazon ECR
     env:
       ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}        
       IMAGE_TAG: ${{ steps.commit.outputs.short }}
     run: |
       docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
       docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
   - name: Update kube config
     run: aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
   - name: Deploy to EKS
     env:
       ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}        
       IMAGE_TAG: ${{ steps.commit.outputs.short }}
     run: |
       kubectl version
       sed -i.bak "s|DOCKER_IMAGE|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" deployment/yoga-app-deployment.yaml
       kubectl apply -f deployment/yoga-app-deployment.yaml
       kubectl apply -f deployment/yoga-app-service.yaml
